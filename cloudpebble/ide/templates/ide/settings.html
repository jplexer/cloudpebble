{% extends "common/base-narrow.html" %}
{% load static %}
{% load i18n %}

{% block head %}
    <link rel="stylesheet" type="text/css" href="{% static 'ide/css/settings.css' %}">
{% endblock %}

{% block headercontent %}
<ul class="nav-pills">
    <li><a href="{% url 'ide:index' %}" class="btn">{% trans 'Projects' %}</a></li>
    <li><a class="active btn">{% trans 'Settings' %}</a></li>
    <li><a href="{% url 'logout' %}" class="btn">{% trans 'Sign out' %}</a></li>
</ul>
{% endblock %}

{% block narrowcontent %}
<div class="settings-container">
    <div class="editor-settings">
        <h2 class="section-heading">{% trans 'Editor settings' %}</h2>
        <div class="well">
            <form method="post" class="form-horizontal" id="user-settings-form">
                {% if saved %}
                    <div class="well alert alert-success">{% trans 'Settings saved!' %}</div>
                {% endif %}
                {% for hidden in form.hidden_fields %}
                {{ hidden }}
                {% endfor %}
                {% for field in form.visible_fields %}
                <div class="control-group">
                    <label for="id_{{field.html_name}}">{{field.label}}</label>
                    <div class="controls">
                        {{ field }}
                        <span class="help-block hide"></span>
                    </div>
                </div>
                {% endfor %}
                <div class="form-actions">
                    <input type="reset" class="btn" value="{% trans 'Reset' %}">
                </div>
            </form>
        </div>
    </div>
    <div class="github-settings">
        <h2 class="section-heading">{% trans 'GitHub Integrations' %}</h2>
        <div class="well github-card">
            <h3 class="github-card-title">{% trans 'GitHub Repo Sync' %}</h3>
            {% if github_repo_sync and github_repo_sync.token %}
            <div class="github-identity">
                <img src="{{ github_repo_sync.avatar }}" class="github-avatar">
                <h2 class="github-username">{{ github_repo_sync.username }}</h2>
            </div>
            {% endif %}
            <div class="github-options">
                <div class="github-actions-list">
                {% if github_repo_sync and github_repo_sync.token %}
                <form method="post" action="{% url 'ide:start_github_repo_sync_auth' %}" class="github-action">
                    <input type="submit" class="btn btn-primary" value="{% trans 'Re-authenticate' %}">
                    {% csrf_token %}
                </form>
                <form method="post" action="{% url 'ide:remove_github_repo_sync_auth' %}" class="github-action">
                    <input type="submit" class="btn btn-primary" value="{% trans 'Unlink account' %}">
                    {% csrf_token %}
                </form>
                {% else %}
                <a href="https://github.com/apps/cloudpebble-repo-sync/installations/new" target="_blank" rel="noopener" class="btn">
                    {% trans 'Install GitHub app' %}
                </a>
                <form method="post" action="{% url 'ide:start_github_repo_sync_auth' %}" class="github-action">
                    <input type="submit" class="btn btn-primary" value="{% trans 'Link your GitHub account' %}">
                    {% csrf_token %}
                </form>
                {% endif %}
                </div>
                <p class="github-help">{% trans 'Used for linking projects to GitHub repositories and push/pull sync.' %}</p>
            </div>
        </div>
        <div class="well github-card">
            <h3 class="github-card-title">{% trans 'Cloud Dev Connection' %}</h3>
            {% if github_dev and github_dev.token %}
            <div class="github-identity">
                <img src="{{ github_dev.avatar }}" class="github-avatar">
                <h2 class="github-username">{{ github_dev.username }}</h2>
            </div>
            {% endif %}
            <div class="github-options">
                <div class="github-actions-list">
                {% if github_dev and github_dev.token %}
                <form method="post" action="{% url 'ide:start_github_dev_auth' %}" class="github-action">
                    <input type="submit" class="btn btn-primary" value="{% trans 'Re-authenticate' %}">
                    {% csrf_token %}
                </form>
                <form method="post" action="{% url 'ide:remove_github_dev_auth' %}" class="github-action">
                    <input type="submit" class="btn btn-primary" value="{% trans 'Unlink account' %}">
                    {% csrf_token %}
                </form>
                {% else %}
                <form method="post" action="{% url 'ide:start_github_dev_auth' %}" class="github-action">
                    <input type="submit" class="btn btn-primary" value="{% trans 'Link your GitHub account' %}">
                    {% csrf_token %}
                </form>
                {% endif %}
                </div>
                <p class="github-help">{% trans 'Used for Cloud Dev Connection in Build & Run phone mode.' %}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script type="text/javascript">
    $(function() {
        jquery_csrf_setup();

        // Warn about emacs kinda sucking.
        $('#id_keybinds').change(function() {
            if($(this).val() == 'emacs') {
                $(this)
                    .siblings('.help-block')
                    .text("Note: the emacs mapping is limited, and will not work properly in some browsers (e.g. Chrome) that prevent using certain keys.")
                    .removeClass('hide')
            } else {
                $(this).siblings('.help-block').addClass('hide');
            }
        });

        var save = function() {
            return Ajax.Ajax({
                type: "POST",
                url: "settings",
                data: $("#user-settings-form").serialize() // serializes the form's elements.
            });
        };

        make_live_settings_form({
            save_function: save,
            form: $("#user-settings-form")
        }).init();

        $("#user-settings-form").submit(function(e) {
            e.preventDefault();
            return false;
        });
    });
</script>
<script src="{% static 'ide/js/live_settings_form.js' %}" type="text/javascript"></script>
<script src="{% static 'ide/js/csrf.js' %}" type="text/javascript"></script>
{% endblock %}
