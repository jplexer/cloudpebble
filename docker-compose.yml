name: cloudpebble

services:
  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - web
      # - qemu  # Optional - emulator
      # - ycmd  # Optional - code completion

  web:
    build: cloudpebble/
    links:
      - redis
      - postgres
      - s3
      # - qemu  # Optional - emulator
      # - ycmd  # Optional - code completion
    environment:
      - DEBUG=yes
      - RUN_WEB=yes
      - RUN_MIGRATE=yes
      - AWS_ENABLED=yes
      - PORT=80
      - AWS_S3_FAKE_S3=${AWS_S3_FAKE_S3-s3:4569}
      - AWS_S3_ENDPOINT_URL=${AWS_S3_ENDPOINT_URL:-}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_S3_SOURCE_BUCKET=${AWS_S3_SOURCE_BUCKET:-source.cloudpebble.net}
      - AWS_S3_BUILDS_BUCKET=${AWS_S3_BUILDS_BUCKET:-builds.cloudpebble.net}
      - AWS_S3_EXPORT_BUCKET=${AWS_S3_EXPORT_BUCKET:-export.cloudpebble.net}
      - MEDIA_URL=${PUBLIC_URL}/s3builds/
      - QEMU_URLS=${PUBLIC_URL}/
      - YCM_URLS=http://ycmd:80/
      - YCMD_PUBLIC_URL=${YCMD_PUBLIC_URL:-}
      - PUBLIC_URL=${PUBLIC_URL}/
      - EXPECT_SSL=${EXPECT_SSL:-no}
      - LIBPEBBLE_PROXY=wss://cloudpebble-proxy.repebble.com/tool
      - CLOUDPEBBLE_PROXY=${CLOUDPEBBLE_PROXY:-wss://cloudpebble-proxy.repebble.com/tool}
      - PEBBLE_AUTH_URL=https://auth.rebble.io
      - FIREBASE_PROJECT_ID=coreapp-ce061
      - GITHUB_ID=${GITHUB_ID:-}
      - GITHUB_SECRET=${GITHUB_SECRET:-}
      - GITHUB_SYNC_CLIENT_ID=${GITHUB_SYNC_CLIENT_ID:-}
      - GITHUB_SYNC_CLIENT_SECRET=${GITHUB_SYNC_CLIENT_SECRET:-}
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_URL=${DATABASE_URL:-}
      - REDIS_URL=${REDIS_URL:-}

  celery:
    build: cloudpebble/
    links:
      - redis
      - postgres
      - s3
    environment:
      - DEBUG=yes
      - RUN_CELERY=yes
      - AWS_ENABLED=yes
      - EXPORT_ROOT=http://web:80/export.cloudpebble.net/
      - AWS_S3_FAKE_S3=${AWS_S3_FAKE_S3-s3:4569}
      - AWS_S3_ENDPOINT_URL=${AWS_S3_ENDPOINT_URL:-}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_S3_SOURCE_BUCKET=${AWS_S3_SOURCE_BUCKET:-source.cloudpebble.net}
      - AWS_S3_BUILDS_BUCKET=${AWS_S3_BUILDS_BUCKET:-builds.cloudpebble.net}
      - AWS_S3_EXPORT_BUCKET=${AWS_S3_EXPORT_BUCKET:-export.cloudpebble.net}
      - GITHUB_ID=${GITHUB_ID:-}
      - GITHUB_SECRET=${GITHUB_SECRET:-}
      - GITHUB_SYNC_CLIENT_ID=${GITHUB_SYNC_CLIENT_ID:-}
      - GITHUB_SYNC_CLIENT_SECRET=${GITHUB_SYNC_CLIENT_SECRET:-}
      - SECRET_KEY=${SECRET_KEY}
      - DATABASE_URL=${DATABASE_URL:-}
      - REDIS_URL=${REDIS_URL:-}

  qemu:
    build: cloudpebble-qemu-controller/
    restart: unless-stopped
    ports:
      - "80:80"
    environment:
      - EMULATOR_FIXED_LIMIT=${EMULATOR_FIXED_LIMIT:-90}
    profiles:
      - emulator

  ycmd:
    build: cloudpebble-ycmd-proxy/
    profiles:
      - codecomplete

  redis:
    image: redis

  postgres:
    image: postgres:16
    environment:
      - POSTGRES_HOST_AUTH_METHOD=trust
    volumes:
      - postgres-data:/var/lib/postgresql/data

  s3:
    image: kuracloud/fake-s3
    ports:
      - "8003:4569"
    volumes:
      - s3-data:/fakes3_root

volumes:
  postgres-data:
  s3-data:
